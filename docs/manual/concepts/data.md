# Data Processing

Data are a first-class citizen of Constellation. They are transmitted as messages with one or more frames, and mechanisms
are in place which ensure that no data message is lost in transmission.
This document provides an overview of the concepts of data handling in Constellation and details some of the features
available.

## Transmitters & Receivers

Data in Constellation are handled exclusively by [satellites](./satellite.md).
Two types of satellites exits, transmitter satellites which generate data and send it off through the Constellation network,
and receiver satellites which receive data from one or more transmitter satellites and process it, e.g. by storing it to
disk.

## Structure

Data consist of individual messages that are grouped to so-called runs. A run represents a set of data recorded in known
conditions and with a fixed set of parameters.
A new run starts upon entering the `RUN` state of the satellite [finite state machine](./satellite.md#the-finite-state-machine)
and ends with the departure from this state.
Each run is labelled by its _run identifier_, which is provided along with the `start` command sent to the satellite, and
consists of individual data messages.
The first message of a run is the so-called begin-of-run (BOR) message, the last one the end-of-run (EOR) message.
This structure enables checks on sending and receiving side, e.g. that the connection is up and running or that all data have
been transmitted correctly.

## Messages

Messages consist of header and payload.

### Data Messages

sequence is continuously checked at receiver for missing packets
sequence
message tags - by user code, suggestion:

* timestamp_begin
* timestamp_end

### Begin-of-Run & End-of-Run Messages

The header tags of the BOR and EOR messages can be added by the satellite implementations in their respective `starting` and
`stopping` functions. This can be used e.g. to record additional information such as a firmware version read from attached
instrument hardware at the time of starting, or to indicate an accumulated metric at the time of stopping.

The payload of the BOR message contains the configuration of the transmitting satellite at the time of entering the `RUN`
state. Depending on the actual implementation of the satellite itself, this allows to unequivocally infer the setup, state
and configuration of the satellite and its attached hardware from the recorded data.

The payload of the EOR message contains a dictionary with run metadata generated by the Constellation framework.
Typical run metadata entries are:

* `run_id`: the run identifier of this run
* `condition`: the run condition flags at the end of the run
* `condition_code`: the run condition flags code
* `time_start`: the starting time of the run, i.e. the time of sending the BOR message
* `time_end`: the ending time of the run, i.e. the time of sending the EOR message

The run condition flags allows to assess the condition during the `RUN` state of the Constellation and thereby the quality of the
data recorded. Runs are marked with any of the following run condition flags:

* `GOOD` (code: `0x00`, no flag set): The run has concluded normally, no other information has been provided by the sender
* `TAINTED` (code: `0x01`): The data has been marked as tainted by the sender
* `INCOMPLETE` (code: `0x02`): The receiver has noticed missing messages in the sequence
* `INTERRUPTED` (code: `0x04`): The run has been interrupted by this sender because of a failure condition elsewhere in the Constellation
* `ABORTED` (code: `0x08`): The run has been aborted by the sender and the EOR message has been appended by the receiver
